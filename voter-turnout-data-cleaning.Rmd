```{r}
library(dplyr)
library(tidyverse)
library(purrr)
```

# Load and clean 1980-2024 turnout dataset

```{r}
# 1980–2022 general election turnout (historical)
voter_turnout_1980_to_2022 <- read.csv("data/1980-2022_General_Election.csv")

# 2024 general election turnout
voter_turnout_2024 <- read.csv("data/Turnout_2024G_v0.3.csv")
```

Remove United States aggregate row (1980–2022)

```{r}
voter_turnout_1980_to_2022 <- voter_turnout_1980_to_2022 %>%
  filter(STATE != "United States") %>%   
  select(-VOTE_FOR_HIGHEST_OFFICE)      

```

Standardize YEAR, remove "*" from state names (1980–2022)

```{r}
voter_turnout_1980_to_2022 <- voter_turnout_1980_to_2022 %>% mutate(
    YEAR      = as.integer(YEAR),
    STATE     = str_replace(STATE, "\\*$", ""),
    STATE_ABV = STATE_ABV
  )
```

Convert numeric & percent fields to proper numeric form (1980–2022)

```{r}
voter_turnout_1980_to_2022 <- voter_turnout_1980_to_2022 %>% mutate(
    TOTAL_BALLOTS_COUNTED   = parse_number(TOTAL_BALLOTS_COUNTED),
    VAP                     = parse_number(VAP),
    INELIGIBLE_PRISON       = parse_number(INELIGIBLE_PRISON),
    INELIGIBLE_PROBATION   = parse_number(INELIGIBLE_PROBATION),
    INELIGIBLE_PAROLE       = parse_number(INELIGIBLE_PAROLE),
    INELIGIBLE_FELONS_TOTAL = parse_number(INELIGIBLE_FELONS_TOTAL),
    ELIGIBLE_OVERSEAS       = parse_number(ELIGIBLE_OVERSEAS),
    VEP                     = parse_number(VEP),
    NONCITIZEN_PCT    = parse_number(NONCITIZEN_PCT) / 100,
    VEP_TURNOUT_RATE  = parse_number(VEP_TURNOUT_RATE) / 100,
    VAP_TURNOUT_RATE  = parse_number(VAP_TURNOUT_RATE) / 100
  ) 
```

Add election type (presidential vs midterm) (1980–2022)

```{r}
voter_turnout_1980_to_2022 <- voter_turnout_1980_to_2022 %>% mutate(
    election_type = if_else(YEAR %% 4 == 0L, "presidential", "midterm")
  )

```

Rename columns to lower_snake_case for consistency (1980–2022)

```{r}
voter_turnout_1980_to_2022 <- voter_turnout_1980_to_2022 %>%
  rename(
    year                   = YEAR,
    state                  = STATE,
    state_abv              = STATE_ABV,
    total_ballots_counted  = TOTAL_BALLOTS_COUNTED,
    vap                    = VAP,
    vep                    = VEP,
    ineligible_prison      = INELIGIBLE_PRISON,
    ineligible_probation   = INELIGIBLE_PROBATION,
    ineligible_parole      = INELIGIBLE_PAROLE,
    ineligible_felons_total = INELIGIBLE_FELONS_TOTAL,
    eligible_overseas      = ELIGIBLE_OVERSEAS,
    vep_turnout_rate       = VEP_TURNOUT_RATE,
    vap_turnout_rate       = VAP_TURNOUT_RATE,
    noncitizen_pct         = NONCITIZEN_PCT
  )

# Save cleaned dataset (1980–2022)
write_csv(voter_turnout_1980_to_2022, "data/processed-data/1980-2022_General_Election_clean.csv")
```


# Load and clean 2024 turnout dataset

```{r}
voter_turnout_2024 <-  read.csv("data/Turnout_2024G_v0.3.csv")

```

Remove United States aggregate row and auto-generated index column

```{r}
voter_turnout_2024 <- voter_turnout_2024 %>%
  filter(STATE != "United States") %>% select(-X)
  

```

Convert numeric + percent fields (2024)

```{r}
voter_turnout_2024 <- voter_turnout_2024 %>% mutate(
    VAP                     = parse_number(VAP),
    INELIGIBLE_PRISON       = parse_number(INELIGIBLE_PRISON),
    INELIGIBLE_PROBATION   = parse_number(INELIGIBLE_PROBATION),
    INELIGIBLE_PAROLE       = parse_number(INELIGIBLE_PAROLE),
    INELIGIBLE_FELONS_TOTAL = parse_number(INELIGIBLE_FELONS_TOTAL),
    ELIGIBLE_OVERSEAS       = parse_number(ELIGIBLE_OVERSEAS),
    VEP                     = parse_number(VEP),
    NONCITIZEN_PCT    = parse_number(NONCITIZEN_PCT) / 100,
    VEP_TURNOUT_RATE  = parse_number(VEP_TURNOUT_RATE) / 100,
    VAP_TURNOUT_RATE  = parse_number(VAP_TURNOUT_RATE) / 100
  ) 

```

Rename 2024 variables to match the 1980–2022 format

```{r}
voter_turnout_2024 <- voter_turnout_2024 %>%
  rename(
    state                  = STATE,
    state_abv              = STATE_ABV,
    total_ballots_counted  = TOTAL_BALLOTS_COUNTED,
    vap                    = VAP,
    vep                    = VEP,
    ineligible_prison      = INELIGIBLE_PRISON,
    ineligible_probation   = INELIGIBLE_PROBATION,
    ineligible_parole      = INELIGIBLE_PAROLE,
    ineligible_felons_total = INELIGIBLE_FELONS_TOTAL,
    eligible_overseas      = ELIGIBLE_OVERSEAS,
    vep_turnout_rate       = VEP_TURNOUT_RATE,
    vap_turnout_rate       = VAP_TURNOUT_RATE,
    noncitizen_pct         = NONCITIZEN_PCT
  )

```

Add year + election type for 2024 dataset

```{r}
voter_turnout_2024 <- voter_turnout_2024 %>% mutate(
    year = "2024",
    year = as.integer(year),
  )

```

```{r}
voter_turnout_2024 <- voter_turnout_2024 %>%
  mutate(
    election_type = if_else(year %% 4 == 0, "presidential", "midterm")
  )
```

Save cleaned 2024 dataset

```{r}
write_csv(voter_turnout_2024, "data/processed-data/voter_turnout_2024.csv")
```

Combine 1980–2022 and 2024 datasets

```{r}
voter_turnout_all <- bind_rows(
  voter_turnout_1980_to_2022,
  voter_turnout_2024
) %>%
  arrange(desc(year))

head(voter_turnout_all)

# Save combined table
write_csv(
  voter_turnout_all,
  "data/processed-data/voter_turnout_1980_2024_all.csv"
)

```

```{r}
voter_turnout_all <- voter_turnout_all %>%
  select(year, state, state_abv, total_ballots_counted, vap, vep,
         vap_turnout_rate, vep_turnout_rate, election_type)

head(voter_turnout_all)
str(voter_turnout_all)
```

Subsets specific state for analysis focus

```{r}
newyork_turnout <- voter_turnout_all %>%
  filter(state == "New York")

california_turnout <- voter_turnout_all %>%
  filter(state == "California")

ohio_turnout <- voter_turnout_all %>%
  filter(state == "Ohio")

michigan_turnout <- voter_turnout_all %>%
  filter(state == "Michigan")

florida_turnout <- voter_turnout_all %>%
  filter(state == "Florida")

utah_turnout <- voter_turnout_all %>%
  filter(state == "Utah")


head(newyork_turnout)
head(california_turnout)
head(ohio_turnout)
head(michigan_turnout)
head(florida_turnout)
head(utah_turnout)

```

Filter to only selected states for analysis

```{r}
selected_states <- c("New York", "California", "Ohio", "Michigan", "Florida", "Utah")

voter_turnout_selected_states <- voter_turnout_all %>%
  filter(state %in% selected_states)

head(voter_turnout_selected_states)

```

# Data Quality Assessment (Selected States)

Check for missing values

```{r}
# Count missing values per column
missing_summary <- voter_turnout_selected_states %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "column",
               values_to = "missing_count") %>%
  filter(missing_count > 0) %>%
  arrange(desc(missing_count))

print("Missing Values in Selected States:")
print(missing_summary)

# Calculate percentage of missing values
total_rows <- nrow(voter_turnout_selected_states)
if(nrow(missing_summary) > 0) {
  missing_summary <- missing_summary %>%
    mutate(missing_pct = round((missing_count / total_rows) * 100, 2))
  print(missing_summary)
}
```


Normalize VEP turnout rate by state and election type

```{r}

# Calculate mean VEP turnout rate for each state-election type combination
# Then subtract that mean from each observation to get normalized values
voter_turnout_selected_states <- voter_turnout_selected_states %>%
  group_by(state, election_type) %>%
  mutate(
    mean_vep_turnout = mean(vep_turnout_rate, na.rm = TRUE),
    normalized_vep_turnout = vep_turnout_rate - mean_vep_turnout
  ) %>%
  ungroup()


voter_turnout_selected_states %>% arrange(state, election_type, year) %>%

head(20)

```


# Save cleaned and validated dataset

```{r}
write_csv(
  voter_turnout_selected_states,
  "data/processed-data/voter_turnout_selected_states.csv"
)

```